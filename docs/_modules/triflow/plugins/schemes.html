

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>triflow.plugins.schemes &mdash; triflow 0.4.3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="triflow 0.4.3 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> triflow
          

          
            
            <img src="../../../_static/logo_locie.svg" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../schemes.html">Temporal schemes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cookbook/displays.html">Displays</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cookbook.html">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute.html">Contribution guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">triflow</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">triflow</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>triflow.plugins.schemes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for triflow.plugins.schemes</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># coding=utf8</span>

<span class="sd">&quot;&quot;&quot;This module regroups all the implemented temporal schemes.</span>
<span class="sd">They are written as callable class which take the model and some control</span>
<span class="sd">arguments at the init, and perform a computation step every time they are</span>
<span class="sd">called.</span>

<span class="sd">The following solvers are implemented:</span>
<span class="sd">    * Backward and Forward Euler, Crank-Nicolson method (with the Theta class)</span>
<span class="sd">    * Some Rosenbrock Wanner schemes (up to the 6th order) with time controler</span>
<span class="sd">    * All the scipy.integrate.ode integrators with the scipy_ode class.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sps</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="k">import</span> <span class="n">ode</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="k">import</span> <span class="n">norm</span>
<span class="kn">from</span> <span class="nn">toolz</span> <span class="k">import</span> <span class="n">memoize</span>

<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NullHandler</span><span class="p">())</span>
<span class="n">logging</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="ROW_general"><a class="viewcode-back" href="../../../triflow.plugins.html#triflow.plugins.schemes.ROW_general">[docs]</a><span class="k">class</span> <span class="nc">ROW_general</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Rosenbrock Wanner class of temporal solvers</span>

<span class="sd">    The implementation and the different parameters can be found in</span>
<span class="sd">    http://www.digibib.tu-bs.de/?docid=00055262</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@memoize</span>
    <span class="k">def</span> <span class="nf">__cache__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">Id</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csc&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Id</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">b_pred</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">time_stepping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dt_min</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_internal_dt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gamma</span> <span class="o">=</span> <span class="n">gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="o">=</span> <span class="n">b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_b_pred</span> <span class="o">=</span> <span class="n">b_pred</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_s</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_control</span> <span class="o">=</span> <span class="n">time_stepping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tol</span> <span class="o">=</span> <span class="n">tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_iter</span> <span class="o">=</span> <span class="n">max_iter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dt_min</span> <span class="o">=</span> <span class="n">dt_min</span>

<div class="viewcode-block" id="ROW_general.__call__"><a class="viewcode-back" href="../../../triflow.plugins.html#triflow.plugins.schemes.ROW_general.__call__">[docs]</a>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span>
                 <span class="n">hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">:</span> <span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;Perform a step of the solver: took a time and a system state as a</span>
<span class="sd">          triflow Fields container and return the next time step with updated</span>
<span class="sd">          container.</span>

<span class="sd">          Parameters</span>
<span class="sd">          ----------</span>
<span class="sd">          t : float</span>
<span class="sd">              actual time step</span>
<span class="sd">          fields : triflow.Fields</span>
<span class="sd">              actual system state in a triflow Fields</span>
<span class="sd">          dt : float</span>
<span class="sd">              temporal step-size</span>
<span class="sd">          pars : dict</span>
<span class="sd">              physical parameters of the model</span>
<span class="sd">          hook : callable, optional</span>
<span class="sd">              any callable taking the actual time, fields and parameters and return modified fields and parameters. Will be called every internal time step and can be used to include time dependent or conditionnal parameters, boundary conditions...</span>
<span class="sd">          container</span>

<span class="sd">          Returns</span>
<span class="sd">          -------</span>
<span class="sd">          tuple : t, fields</span>
<span class="sd">              updated time and fields container</span>

<span class="sd">          Raises</span>
<span class="sd">          ------</span>
<span class="sd">          NotImplementedError</span>
<span class="sd">              raised if a time stepping is requested but the scheme do not provide the b predictor coefficients.</span>
<span class="sd">          ValueError</span>
<span class="sd">              raised if time_stepping is True and tol is not provided.</span>
<span class="sd">          &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_control</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variable_step</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span>
                                       <span class="n">hook</span><span class="o">=</span><span class="n">hook</span><span class="p">)</span>

        <span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_step</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span>
                                        <span class="n">hook</span><span class="o">=</span><span class="n">hook</span><span class="p">)</span>
        <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span> <span class="o">=</span> <span class="n">hook</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">fields</span></div>

    <span class="k">def</span> <span class="nf">_fixed_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span>
                    <span class="n">hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">:</span> <span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span> <span class="o">=</span> <span class="n">hook</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
        <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">J</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
        <span class="n">Id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cache__</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">uflat</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">Id</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">J</span>
        <span class="n">luf</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">splu</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">ks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fields_i</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_s</span><span class="p">):</span>
            <span class="n">fields_i</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">uflat</span> <span class="o">+</span>
                          <span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">ks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                               <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">)]))</span>
            <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">F</span><span class="p">(</span><span class="n">fields_i</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
            <span class="n">ks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">luf</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">F</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">J</span> <span class="o">@</span> <span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_gamma</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span>
                                                        <span class="n">ks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                                        <span class="k">for</span> <span class="n">j</span>
                                                        <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span>
                                               <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)))</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">uflat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">([</span><span class="n">bi</span> <span class="o">*</span> <span class="n">ki</span> <span class="k">for</span> <span class="n">bi</span><span class="p">,</span> <span class="n">ki</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_b</span><span class="p">,</span> <span class="n">ks</span><span class="p">)])</span>

        <span class="n">U_pred</span> <span class="o">=</span> <span class="p">(</span><span class="n">U</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">([</span><span class="n">bi</span> <span class="o">*</span> <span class="n">ki</span>
                           <span class="k">for</span> <span class="n">bi</span><span class="p">,</span> <span class="n">ki</span>
                           <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_b_pred</span><span class="p">,</span> <span class="n">ks</span><span class="p">)])</span>
                  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b_pred</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">U</span> <span class="o">-</span> <span class="n">U_pred</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">U_pred</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_variable_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span>
                       <span class="n">hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">:</span> <span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_next_time_step</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_internal_iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_dt</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1E-6</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_dt</span> <span class="ow">is</span> <span class="kc">None</span>
                                  <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_dt</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_err</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">while</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_err</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_err</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tol</span><span class="p">):</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">newfields</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_step</span><span class="p">(</span><span class="n">t</span><span class="p">,</span>
                                                           <span class="n">fields</span><span class="p">,</span>
                                                           <span class="n">dt</span><span class="p">,</span>
                                                           <span class="n">pars</span><span class="p">,</span>
                                                           <span class="n">hook</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;error: </span><span class="si">{self._err}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tol</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_err</span><span class="p">))</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">newfields</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;dt computed after err below tol: </span><span class="si">{dt}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;ROS_vart, t </span><span class="si">{t}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_time_step</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;new t more than next expected time step&#39;</span><span class="p">)</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_time_step</span> <span class="o">-</span> <span class="n">t</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;dt falling to </span><span class="si">{dt}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_internal_dt</span> <span class="o">=</span> <span class="n">dt</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_dt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_internal_iter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_time_step</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_internal_dt</span> <span class="o">=</span> <span class="n">dt</span>
                <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span> <span class="o">=</span> <span class="n">hook</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_time_step</span><span class="p">,</span> <span class="n">fields</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_iter</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_iter</span>
                                      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_iter</span>
                                      <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Rosebrock internal iteration &quot;</span>
                                   <span class="s2">&quot;above max iterations authorized&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_dt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dt_min</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt_min</span>
                                    <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_dt</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Rosebrock internal time step &quot;</span>
                                   <span class="s2">&quot;less than authorized&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ROS2"><a class="viewcode-back" href="../../../triflow.plugins.html#triflow.plugins.schemes.ROS2">[docs]</a><span class="k">class</span> <span class="nc">ROS2</span><span class="p">(</span><span class="n">ROW_general</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Second order Rosenbrock scheme, without time stepping</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : triflow.Model</span>
<span class="sd">        triflow Model</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">2.928932188134E-1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                          <span class="p">[</span><span class="o">-</span><span class="mf">5.857864376269E-1</span><span class="p">,</span> <span class="mf">2.928932188134E-1</span><span class="p">]])</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">time_stepping</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="ROS3PRw"><a class="viewcode-back" href="../../../triflow.plugins.html#triflow.plugins.schemes.ROS3PRw">[docs]</a><span class="k">class</span> <span class="nc">ROS3PRw</span><span class="p">(</span><span class="n">ROW_general</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Third order Rosenbrock scheme, with time stepping</span>

<span class="sd">      Parameters</span>
<span class="sd">      ----------</span>
<span class="sd">      model : triflow.Model</span>
<span class="sd">          triflow Model</span>
<span class="sd">      tol : float, optional, default 1E-2</span>
<span class="sd">          tolerance factor for the time stepping. The time step will adapt to ensure that the maximum relative error on all fields stay under that value.</span>
<span class="sd">      time_stepping : bool, optional, default True</span>
<span class="sd">          allow a variable internal time-step to ensure good agreement between computing performance and accuracy.</span>
<span class="sd">      max_iter : float or None, optional, default None</span>
<span class="sd">          maximum internal iteration allowed</span>
<span class="sd">      dt_min : float or None, optional, default None</span>
<span class="sd">          minimum internal time step allowed</span>
<span class="sd">      &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1E-2</span><span class="p">,</span> <span class="n">time_stepping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">max_iter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dt_min</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">gamma_i</span> <span class="o">=</span> <span class="mf">7.8867513459481287e-01</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">5.0544867840851759e-01</span><span class="p">,</span>
             <span class="o">-</span><span class="mf">1.1571687603637559e-01</span><span class="p">,</span>
             <span class="mf">6.1026819762785800e-01</span><span class="p">]</span>
        <span class="n">b_pred</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.8973180237214197e-01</span><span class="p">,</span>
                  <span class="mf">1.0000000000000001e-01</span><span class="p">,</span>
                  <span class="mf">6.1026819762785800e-01</span><span class="p">]</span>

        <span class="n">alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.3660254037844388e+00</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.0000000000000000e-01</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">7.6794919243112270e-01</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma_i</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.3660254037844388e+00</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">8.6791218280355165e-01</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">8.7306695894642317e-01</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">b_pred</span><span class="o">=</span><span class="n">b_pred</span><span class="p">,</span>
                         <span class="n">time_stepping</span><span class="o">=</span><span class="n">time_stepping</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
                         <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">dt_min</span><span class="o">=</span><span class="n">dt_min</span><span class="p">)</span></div>


<div class="viewcode-block" id="ROS3PRL"><a class="viewcode-back" href="../../../triflow.plugins.html#triflow.plugins.schemes.ROS3PRL">[docs]</a><span class="k">class</span> <span class="nc">ROS3PRL</span><span class="p">(</span><span class="n">ROW_general</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;4th order Rosenbrock scheme, with time stepping</span>

<span class="sd">      Parameters</span>
<span class="sd">      ----------</span>
<span class="sd">      model : triflow.Model</span>
<span class="sd">          triflow Model</span>
<span class="sd">      tol : float, optional, default 1E-2</span>
<span class="sd">          tolerance factor for the time stepping. The time step will adapt to ensure that the maximum relative error on all fields stay under that value.</span>
<span class="sd">      time_stepping : bool, optional, default True</span>
<span class="sd">          allow a variable internal time-step to ensure good agreement between computing performance and accuracy.</span>
<span class="sd">      max_iter : float or None, optional, default None</span>
<span class="sd">          maximum internal iteration allowed</span>
<span class="sd">      dt_min : float or None, optional, default None</span>
<span class="sd">          minimum internal time step allowed</span>
<span class="sd">      &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1E-2</span><span class="p">,</span> <span class="n">time_stepping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">max_iter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dt_min</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">gamma_i</span> <span class="o">=</span> <span class="mf">4.3586652150845900e-01</span>

        <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.1103008548132443e-03</span><span class="p">,</span>
             <span class="mf">8.8607515441580453e-01</span><span class="p">,</span>
             <span class="o">-</span><span class="mf">3.2405197677907682e-01</span><span class="p">,</span>
             <span class="mf">4.3586652150845900e-01</span><span class="p">]</span>
        <span class="n">b_pred</span> <span class="o">=</span> <span class="p">[</span><span class="mf">5.0000000000000000e-01</span><span class="p">,</span>
                  <span class="mf">3.8752422953298199e-01</span><span class="p">,</span>
                  <span class="o">-</span><span class="mf">2.0949226315045236e-01</span><span class="p">,</span>
                  <span class="mf">3.2196803361747034e-01</span><span class="p">]</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)):</span>
            <span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma_i</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0000000000000000e-01</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">7.9156480420464204e-01</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.5244216792751432e-01</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.9788969914518677e-01</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.8607515441580453e-01</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.2405197677907682e-01</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">b_pred</span><span class="o">=</span><span class="n">b_pred</span><span class="p">,</span>
                         <span class="n">time_stepping</span><span class="o">=</span><span class="n">time_stepping</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
                         <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">dt_min</span><span class="o">=</span><span class="n">dt_min</span><span class="p">)</span></div>


<div class="viewcode-block" id="RODASPR"><a class="viewcode-back" href="../../../triflow.plugins.html#triflow.plugins.schemes.RODASPR">[docs]</a><span class="k">class</span> <span class="nc">RODASPR</span><span class="p">(</span><span class="n">ROW_general</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;6th order Rosenbrock scheme, with time stepping</span>

<span class="sd">      Parameters</span>
<span class="sd">      ----------</span>
<span class="sd">      model : triflow.Model</span>
<span class="sd">          triflow Model</span>
<span class="sd">      tol : float, optional, default 1E-2</span>
<span class="sd">          tolerance factor for the time stepping. The time step will adapt to ensure that the maximum relative error on all fields stay under that value.</span>
<span class="sd">      time_stepping : bool, optional, default True</span>
<span class="sd">          allow a variable internal time-step to ensure good agreement between computing performance and accuracy.</span>
<span class="sd">      max_iter : float or None, optional, default None</span>
<span class="sd">          maximum internal iteration allowed</span>
<span class="sd">      dt_min : float or None, optional, default None</span>
<span class="sd">          minimum internal time step allowed</span>
<span class="sd">      &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1E-2</span><span class="p">,</span> <span class="n">time_stepping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">max_iter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dt_min</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">7.9683251690137014E-1</span><span class="p">,</span>
             <span class="mf">6.2136401428192344E-2</span><span class="p">,</span>
             <span class="mf">1.1198553514719862E00</span><span class="p">,</span>
             <span class="mf">4.7198362114404874e-1</span><span class="p">,</span>
             <span class="o">-</span><span class="mf">1.0714285714285714E-1</span><span class="p">,</span>
             <span class="mf">2.5e-1</span><span class="p">]</span>
        <span class="n">b_pred</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">7.3844531665375115e0</span><span class="p">,</span>
                  <span class="o">-</span><span class="mf">3.0593419030174646e-1</span><span class="p">,</span>
                  <span class="mf">7.8622074209377981e0</span><span class="p">,</span>
                  <span class="mf">5.7817993590145966e-1</span><span class="p">,</span>
                  <span class="mf">2.5e-1</span><span class="p">,</span>
                  <span class="mi">0</span><span class="p">]</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">7.5E-1</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">7.5162877593868457E-2</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.4837122406131545E-2</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.6532708886396510e0</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.1545706385445562e-1</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.3157488872766792e0</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.9385003738039885e1</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.2007117225835324e0</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.9337924059522791e1</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.4779140110062559e-1</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">7.3844531665375115e0</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.0593419030174646e-1</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">7.8622074209377981e0</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.7817993590145966e-1</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.5e-1</span>
        <span class="n">gamma_i</span> <span class="o">=</span> <span class="o">.</span><span class="mi">25</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)):</span>
            <span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma_i</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">7.5e-1</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">8.8644e-2</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.868897e-2</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.84700e0</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.1583e-1</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">4.9536568e0</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.67694569e1</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5066459e0</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.720013e1</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">8.25971337e-1</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">6.58762e0</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.6807059e-1</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.74235e0</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.061963e-1</span>
        <span class="n">gamma</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.57142857e-1</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">b_pred</span><span class="o">=</span><span class="n">b_pred</span><span class="p">,</span>
                         <span class="n">time_stepping</span><span class="o">=</span><span class="n">time_stepping</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
                         <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">dt_min</span><span class="o">=</span><span class="n">dt_min</span><span class="p">)</span></div>


<div class="viewcode-block" id="scipy_ode"><a class="viewcode-back" href="../../../triflow.plugins.html#triflow.plugins.schemes.scipy_ode">[docs]</a><span class="k">class</span> <span class="nc">scipy_ode</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Proxy written around the scipy.integrate.ode class. Give access to all</span>
<span class="sd">      the scpy integrators.</span>

<span class="sd">      Parameters</span>
<span class="sd">      ----------</span>
<span class="sd">      model : triflow.Model</span>
<span class="sd">          triflow Model</span>
<span class="sd">      integrator : str, optional, default &#39;vode&#39;</span>
<span class="sd">          name of the chosen scipy integration scheme.</span>
<span class="sd">      **integrator_kwargs</span>
<span class="sd">          extra arguments provided to the scipy integration scheme.</span>
<span class="sd">      &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">integrator</span><span class="o">=</span><span class="s1">&#39;vode&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">integrator_kwargs</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">func_scipy_proxy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
            <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span> <span class="o">=</span> <span class="n">hook</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">F</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">jacob_scipy_proxy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
            <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span> <span class="o">=</span> <span class="n">hook</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">J</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_solv</span> <span class="o">=</span> <span class="n">ode</span><span class="p">(</span><span class="n">func_scipy_proxy</span><span class="p">,</span>
                         <span class="n">jac</span><span class="o">=</span><span class="n">jacob_scipy_proxy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solv</span><span class="o">.</span><span class="n">set_integrator</span><span class="p">(</span><span class="n">integrator</span><span class="p">,</span> <span class="o">**</span><span class="n">integrator_kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="scipy_ode.__call__"><a class="viewcode-back" href="../../../triflow.plugins.html#triflow.plugins.schemes.scipy_ode.__call__">[docs]</a>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span>
                 <span class="n">hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">:</span> <span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;Perform a step of the solver: took a time and a system state as a</span>
<span class="sd">          triflow Fields container and return the next time step with updated</span>
<span class="sd">          container.</span>

<span class="sd">          Parameters</span>
<span class="sd">          ----------</span>
<span class="sd">          t : float</span>
<span class="sd">              actual time step</span>
<span class="sd">          fields : triflow.Fields</span>
<span class="sd">              actual system state in a triflow Fields</span>
<span class="sd">          dt : float</span>
<span class="sd">              temporal step-size</span>
<span class="sd">          pars : dict</span>
<span class="sd">              physical parameters of the model</span>
<span class="sd">          hook : callable, optional</span>
<span class="sd">              any callable taking the actual time, fields and parameters and return modified fields and parameters. Will be called every internal time step and can be used to include time dependent or conditionnal parameters, boundary conditions...</span>
<span class="sd">          container</span>

<span class="sd">          Returns</span>
<span class="sd">          -------</span>
<span class="sd">          tuple : t, fields</span>
<span class="sd">              updated time and fields container</span>

<span class="sd">          Raises</span>
<span class="sd">          ------</span>
<span class="sd">          RuntimeError</span>
<span class="sd">              Description</span>
<span class="sd">          &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

        <span class="n">solv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solv</span>
        <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span> <span class="o">=</span> <span class="n">hook</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
        <span class="n">solv</span><span class="o">.</span><span class="n">set_initial_value</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">uflat</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">solv</span><span class="o">.</span><span class="n">set_f_params</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">hook</span><span class="p">)</span>
        <span class="n">solv</span><span class="o">.</span><span class="n">set_jac_params</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">hook</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">solv</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="n">fields</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">hook</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span> <span class="n">fields</span></div></div>


<div class="viewcode-block" id="Theta"><a class="viewcode-back" href="../../../triflow.plugins.html#triflow.plugins.schemes.Theta">[docs]</a><span class="k">class</span> <span class="nc">Theta</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simple theta-based scheme where theta is a weight</span>
<span class="sd">          if theta = 0, the scheme is a forward-euler scheme</span>
<span class="sd">          if theta = 1, the scheme is a backward-euler scheme</span>
<span class="sd">          if theta = 0.5, the scheme is called a Crank-Nicolson scheme</span>

<span class="sd">      Parameters</span>
<span class="sd">      ----------</span>
<span class="sd">      model : triflow.Model</span>
<span class="sd">          triflow Model</span>
<span class="sd">      theta : int, optional, default 1</span>
<span class="sd">          weight of the theta-scheme</span>
<span class="sd">      solver : callable, optional, default scipy.sparse.linalg.spsolve</span>
<span class="sd">          method able to solve a Ax = b linear equation with A a sparse matrix. Take A and b as argument and return x.</span>
<span class="sd">      &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">sps</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">spsolve</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_theta</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="o">=</span> <span class="n">solver</span>

<div class="viewcode-block" id="Theta.__call__"><a class="viewcode-back" href="../../../triflow.plugins.html#triflow.plugins.schemes.Theta.__call__">[docs]</a>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span>
                 <span class="n">hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">:</span> <span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;Perform a step of the solver: took a time and a system state as a</span>
<span class="sd">          triflow Fields container and return the next time step with updated</span>
<span class="sd">          container.</span>

<span class="sd">          Parameters</span>
<span class="sd">          ----------</span>
<span class="sd">          t : float</span>
<span class="sd">              actual time step</span>
<span class="sd">          fields : triflow.Fields</span>
<span class="sd">              actual system state in a triflow Fields container</span>
<span class="sd">          dt : float</span>
<span class="sd">              temporal step-size</span>
<span class="sd">          pars : dict</span>
<span class="sd">              physical parameters of the model</span>
<span class="sd">          hook : callable, optional</span>
<span class="sd">              any callable taking the actual time, fields and parameters and return modified fields and parameters. Will be called every internal time step and can be used to include time dependent or conditionnal parameters, boundary conditions...</span>

<span class="sd">          Returns</span>
<span class="sd">          -------</span>
<span class="sd">          tuple : t, fields</span>
<span class="sd">              updated time and fields container</span>
<span class="sd">          &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span> <span class="o">=</span> <span class="n">hook</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">F</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
        <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">J</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">uflat</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">F</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta</span> <span class="o">*</span> <span class="n">J</span> <span class="o">@</span> <span class="n">U</span><span class="p">)</span> <span class="o">+</span> <span class="n">U</span>
        <span class="n">J</span> <span class="o">=</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                          <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csc&#39;</span><span class="p">)</span> <span class="o">-</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_theta</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">J</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">B</span><span class="p">))</span>
        <span class="n">fields</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">hook</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span> <span class="n">fields</span></div></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Nicolas Cellier.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.4.3',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>